#!/usr/bin/env ruby
# encoding=utf-8

$LOAD_PATH << File.dirname(__FILE__)+"/../lib"

require 'zdns'
require 'zdns/ar'
require "optparse"

config = ZDNS::Config.new
config_path = nil

OptionParser.new do |opt|
  opt.on('-c config_file', '--config=config_file') {|path|
    config_path = path
  }
  opt.parse!(ARGV)
end

begin
  if config_path
    config.load_file(config_path)
  else
    config.load_default_file
  end

rescue => e
  puts e.to_s
  exit 1
end

ctrl = ZDNS::AR::Control.new(config[:server][:database])
subcommand = ARGV.shift.to_s.downcase

begin
  ctrl.send(subcommand, *ARGV)
  exit 0

rescue ZDNS::AR::ControlError, ActiveRecord::RecordInvalid => e
  puts e.message
  puts
  ctrl.help(subcommand, *ARGV)
  exit 1

rescue => e
  p e.class
  puts e.message
  puts e.backtrace.join("\n")
  exit 1
end
