<!DOCTYPE html>
<html lang="ja" manifest="/cache.appcache">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="/css/jquery-ui.css" />
  <script src="/js/jquery.js"></script>
  <script src="/js/jquery-ui.js"></script>
  <script>
    $(function(){
      var App = function() {
        var app = this;

        // cache
        var zones = null;
        var records = {};

        // current status
        var current_zone_id = null;
        var current_record_type = null;

        app.getCurrentZone = function() {
          var zone = null;
          try {
            zone = records[current_zone_id]["soa"];
          } catch(e) {
            if (zones) {
              for (var i=0; i<zones.length; i++) {
                if (zones[i]["id"]==current_zone_id) {
                  zone = zones[i];
                  break;
                }
              }
            }
          }
          return zone || {};
        };

        app.getCurrentAnyRecords = function() {
          return records[current_zone_id] || {};
        };

        app.getCurrentRecords = function(record_type) {
          return app.getCurrentAnyRecords()[record_type] || [];
        };

        // record default data
        var defaults = {
          soa: {
            name: "example.com.",
            ttl: 3600,
            mname: "ns.example.com.",
            rname: "root.example.com.",
            serial: (function(){
              var d = new Date();
              var y = d.getFullYear()*10000;
              var m = (d.getMonth()+1)*100;
              var d = d.getDate();
              return y+m+d+"";
            })(),
            refresh: "14400",
            retry: "3600",
            expire: "604800",
            minimum: "7200"
          },
          a: {
            name: "www",
            ttl: 3600,
            address: "192.168.1.80",
            enable_ptr: true
          },
          ns: {
            name: "@",
            ttl: 3600,
            nsdname: "ns"
          },
          cname: {
            name: "@",
            ttl: 3600,
            cname: "www.example.com."
          },
          mx: {
            name: "@",
            ttl: 3600,
            preference: 10,
            exchange: "mx.example.com."
          },
          txt: {
            name: "@",
            ttl: 3600,
            txt_data: "v=spf1 +ip4:192.168.1.25/32 -all"
          },
          aaaa: {
            name: "@",
            ttl: 3600,
            address: "2001:db8::80",
            enable_ptr: true
          }
        };

        app.recordTypes = function(include_soa, callback) {
          for (var k in defaults) {
            k!="soa" || include_soa ? callback(k) : null;
          };
        };

        app.recordKeys = function(type, callback) {
          for (var k in defaults[type] || {}) {
            callback(k);
          }
        };

        // start application

        app.start = function() {
          app.renderInitialize();

          $(window).bind('hashchange', function() {
            app.dispatch(location.hash);
          });
          app.dispatch(location.hash);
        };

        // routes

        app.dispatch = function(hash) {
          if (m = hash.match(/^#(\d+)(?:\/(soa|a|ns|cname|mx|txt|aaaa))?\/?$/)) {
            app.showPage(m[1], m[2]);
          } else {
            app.showInitialPage();
          }
        };

        // controller

        app.showPage = function(zone_id, record_type) {
          zone_id = parseInt(zone_id);
          current_record_type = record_type || "soa";

          // zone
          app.fetchZones(function(is_renew){
            if (is_renew) {
              app.refrectZones();
              app.renderZones();
            }
          });

          // records
          app.renderLoading();
          app.fetchRecords(zone_id, function(changed) {
            if (changed) {
              app.refrectRecords();
            }
            app.renderRecords();
          });

          // navigation
          app.renderNavView();
        };

        app.showInitialPage = function() {
          app.fetchZones(function(is_renew){
            if (is_renew) {
              app.refrectZones();
            }

            // select first zone
            var zone_id = 0;
            try {
              zone_id = zones[0]["id"];
            } catch(e) {
            }
            app.showPage(zone_id);
          });
        }

        // model

        app.fetchZones = function(callback) {
          if (!zones) {
            // ajax
            $.getJSON("/api/zone", function(data){
              zones = data;
              if (callback) {
                callback(true);
              }
            });
          } else {
            // use cache
            if (callback) {
              callback(false);
            }
          }
        };

        app.fetchRecords = function(zone_id, callback) {
          var changed = current_zone_id!=zone_id;
          current_zone_id = zone_id;

          if (!records[zone_id]) {
            // ajax
            $.getJSON("/api/zone/"+zone_id+"/any", function(data){
              records[zone_id] = data;
              if (callback) {
                callback(changed);
              }
            });
          } else {
            // use cache
            if (callback) {
              callback(changed);
            }
          }
        };

        // view refrect (dom)

        app.refrectZones = function() {
          var list = $("#zonelist");
          list.empty();
          for (var i=0; i<zones.length; i++) {
            var zone = zones[i];
            var item = $("<a/>")
              .attr("href", "#"+zone["id"])
              .attr("title", zone["name"])
              .text(zone["name"]);
            item = $("<li/>").addClass("zone"+zone["id"]).append(item);
            list.append(item);
          };
        };

        app.refrectRecords = function() {
          // record navigation
          $("#record-nav > input").unbind("click");
          app.recordTypes(true, function(type) {
            $("#link-"+type).bind("click", function() {
              location.hash = "#"+current_zone_id+"/"+type;
            });
          });

          // soa
          app.recordKeys("soa", function(key) {
            var value = app.getCurrentZone()[key] || "";
            $(".soa-"+key).text(value);
          });

          // a ns cname mx txt aaaa
          app.recordTypes(false, function(type) {
            $("#page-"+type+" .record-table tbody").empty();
            $.each(app.getCurrentRecords(type), function(i, value) {
              var item = $("<tr/>");
              app.recordKeys(type, function(key) {
                item.append($("<td/>").text(value[key]).addClass(type+"-"+key));
              });
              $("#page-"+type+" .record-table tbody").append(item);
            });
          });

          // zone name
          var zone_name = app.getCurrentZone()["name"];
          $(".zone-name").text(zone_name || "(no selected zone)");
        };

        // view render (css / js)

        app.renderInitialize = function() {
          //$(document).tooltip();
          $(".tooltip").tooltip();

          // new zone button
          $("#newzone").button();

          // location back button
          $("#back").button({
            icons: {
              primary: "ui-icon-arrowreturn-1-w"
            }
          });
          $("#back").bind("click", function() {
            history.back();
          });

          // location reload button
          $("#reload").button({
            icons: {
              primary: "ui-icon-arrowrefresh-1-e"
            }
          });
          $("#reload").bind("click", function() {
            location.reload();
          });

          // record navigation
          $("#record-nav").buttonset();

          // render loading
          app.renderLoading();
        };

        app.renderLoading = function() {
          $("#pages > *").hide();
          $("#loading").show();
        };

        app.renderZones = function() {
          $("#zonelist > li").removeClass("selected");
          $("#zonelist > li.zone"+current_zone_id).addClass("selected");
        };

        app.renderRecords = function() {
          app.renderZones();
          $("#pages > *").hide();
          $("#page-"+current_record_type).show();
        };

        app.renderNavView = function() {
          $("#record-nav > input").prop("checked", false);
          $("#link-"+current_record_type).prop("checked", true);
          $("#record-nav").buttonset();
        };
      };

      new App().start();
    });
  </script>
  <style>
    /* common */
    * {
      font-size: 13px;
    }
    body {
      margin: 0px;
    }
    nav {
      margin-top: 5px;
      margin-bottom: 5px;
    }
    table {
      border-collapse: collapse;
    }
    th {
      text-align: left;
      background-color: #f3f3f3;
      font-size: 12px;
    }
    th, td {
      padding-left: 20px;
      padding-right: 20px;
    }
    a {
      text-decoration: none;
      color: #000000;
    }
    .redbutton {
      color: #ffffff;
      font-weight: bold;
      background: -webkit-gradient(linear, left top, left bottom, color-stop(1.00, #d8492f), color-stop(0.00, #e34c32));
      background: -webkit-linear-gradient(top, #e34c32 0%, #d8492f 100%);
      background: -moz-linear-gradient(top, #e34c32 0%, #d8492f 100%);
      background: -o-linear-gradient(top, #e34c32 0%, #d8492f 100%);
      background: -ms-linear-gradient(top, #e34c32 0%, #d8492f 100%);
      background: linear-gradient(top, #e34c32 0%, #d8492f 100%);
      border: solid 1px #d8492f;
    }
    .redbutton:hover {
      background: -webkit-gradient(linear, left top, left bottom, color-stop(1.00, #cc381e), color-stop(0.00, #e34b31));
      background: -webkit-linear-gradient(top, #e34b31 0%, #cc381e 100%);
      background: -moz-linear-gradient(top, #e34b31 0%, #cc381e 100%);
      background: -o-linear-gradient(top, #e34b31 0%, #cc381e 100%);
      background: -ms-linear-gradient(top, #e34b31 0%, #cc381e 100%);
      background: linear-gradient(top, #e34b31 0%, #cc381e 100%);
      border: solid 1px #b6290f;
      box-shadow: 1px 1px 1px 1px rgba(0,0,0,0.1);
    }
    .redbutton:active {
      background: -webkit-gradient(linear, left top, left bottom, color-stop(1.00, #cc381e), color-stop(0.00, #e14a30));
      background: -webkit-linear-gradient(top, #e14a30 0%, #cc381e 100%);
      background: -moz-linear-gradient(top, #e14a30 0%, #cc381e 100%);
      background: -o-linear-gradient(top, #e14a30 0%, #cc381e 100%);
      background: -ms-linear-gradient(top, #e14a30 0%, #cc381e 100%);
      background: linear-gradient(top, #e14a30 0%, #cc381e 100%);
      border: solid 1px #b6290f;
      box-shadow: 1px 1px 1px 1px rgba(0,0,0,0.1) inset;
    }
    .ui-icon {
    }

    /* container */
    #container {
      width: 100%;
      display: -webkit-box;
      display: -moz-box;
    }

    /* zone-container */
    #zone-container {
      width: 200px;
      -webkit-box-ordinal-group: 1;
      -moz-box-ordinal-group: 1;
    }

    /* record-container */
    #record-container {
      -webkit-box-flex: 1;
      -moz-box-flex: 1;
      -webkit-box-ordinal-group: 2;
      -moz-box-ordinal-group: 2;
    }

    /* zone */
    #zone-container > h2 {
      padding-left: 10px;
      padding-right: 10px;
    }
    #newzone {
      width: 170px;
      margin-left: 10px;
    }
    #zonelist {
      width: 180px;
      margin-left: 3px;
      padding: 0px;
    }
    #zonelist > li {
      list-style: none;
    }
    #zonelist > li :hover {
      background-color: #eee;
    }
    #zonelist > li > a {
      display: block;
      width: 100%;
      padding-left: 10px;
      padding-right: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #zonelist > li.selected {
      margin-left: -3px;
      border-left: solid 3px #dd4b39;
      font-weight: bold;
    }
    #zonelist > li.selected > a {
      color: #dd4b39;
    }

    /* navigation */
    #back, #reload {
      width: 30px;
      height: 30px;
    }

    /* page */
    #pages {
      margin: 10px;
    }
    .record-table {
    }
    .record-table tr {
      border-bottom: solid 1px #ebebeb;
    }
    .record-table tr:first-child {
      border-top: solid 1px #ebebeb;
    }
  </style>
</head>

<body>
  <div id="container">
    <section id="zone-container">
      <h2>Zone List</h2>
      <a id="newzone" class="redbutton">Compose Zone</a>
      <ul id="zonelist"></ul>
    </section>

    <div id="record-container">
      <nav id="location-nav">
        <a id="back" title="Back">&nbsp;</a>
        <a id="reload" title="Reload">&nbsp;</a>
      </nav>

      <nav id="record-nav">
        <input type="radio" name="record-nav" id="link-soa" /><label for="link-soa">SOA</label>
        <input type="radio" name="record-nav" id="link-a" /><label for="link-a">A</label>
        <input type="radio" name="record-nav" id="link-ns" /><label for="link-ns">NS</label>
        <input type="radio" name="record-nav" id="link-cname" /><label for="link-cname">CNAME</label>
        <input type="radio" name="record-nav" id="link-mx" /><label for="link-mx">MX</label>
        <input type="radio" name="record-nav" id="link-txt" /><label for="link-txt">TXT</label>
        <input type="radio" name="record-nav" id="link-aaaa" /><label for="link-aaaa">AAAA</label>
      </nav>

      <div id="pages">
        <section id="loading">
          loading...
        </section>

        <section id="page-soa">
          <h2><span class="zone-name"></span> &gt; SOA</h2>
          <table class="record-table">
            <tbody>
              <tr>
                <th>Name</th>
                <td class="soa-name"></td>
              </tr>
              <tr>
                <th>TTL</th>
                <td class="soa-ttl"></td>
              </tr>
              <tr>
                <th>Primary NameServer</th>
                <td class="soa-mname"></td>
              </tr>
              <tr>
                <th>Responsible Person</th>
                <td class="soa-rname"></td>
              </tr>
              <tr>
                <th>Serial</th>
                <td class="soa-serial"></td>
              </tr>
              <tr>
                <th>Refresh</th>
                <td class="soa-refresh"></td>
              </tr>
              <tr>
                <th>Retry</th>
                <td class="soa-retry"></td>
              </tr>
              <tr>
                <th>Expire</th>
                <td class="soa-expire"></td>
              </tr>
              <tr>
                <th>Minimum TTL</th>
                <td class="soa-minimum"></td>
              </tr>
            </tbody>
          </table>
        </section>

        <section id="page-a">
          <h2><span class="zone-name"></span> &gt; A</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Address</th>
                <th>Enable PTR</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <section id="page-ns">
          <h2><span class="zone-name"></span> &gt; NS</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Name Server</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <section id="page-cname">
          <h2><span class="zone-name"></span> &gt; CNAME</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Original Server</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <section id="page-mx">
          <h2><span class="zone-name"></span> &gt; MX</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Preference</th>
                <th>Mail Server</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <section id="page-txt">
          <h2><span class="zone-name"></span> &gt; TXT</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Text</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <section id="page-aaaa">
          <h2><span class="zone-name"></span> &gt; AAAA</h2>
          <table class="record-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>TTL</th>
                <th>Address</th>
                <th>Enable PTR</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>
      </div>
    </div>
  </div>

</body>
</html>
